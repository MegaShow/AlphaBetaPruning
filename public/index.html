<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Chinese Chess</title>
</head>

<body>
  <script src="wasm_exec.js"></script>
  <script type="text/javascript" src="jquery/jquery.js"></script>
  <script type="text/javascript" src="vschess/vschess.min.js"></script>
  <script>
    if (!WebAssembly.instantiateStreaming) { // polyfill
      WebAssembly.instantiateStreaming = async (resp, importObject) => {
        const source = await (await resp).arrayBuffer()
        return await WebAssembly.instantiate(source, importObject)
      }
    }

    const go = new Go()
    let mod, inst, chess

    WebAssembly.instantiateStreaming(fetch("index.wasm"), go.importObject).then(async (result) => {
      mod = result.module
      inst = result.instance
      chess = new vschess.load(".vschess", {
        clickResponse: vschess.code.clickResponse.red,
        afterClickAnimate: function () {
          let moveList = this.getMoveList()
          let lastMove = moveList[moveList.length - 1]
          let lastEat = 0
          for (let i = chess.eatStatus.length - 1; i >= 0; --i) {
            if (chess.eatStatus[i]) {
              lastEat = i
              break
            }
          }
          let lastEatFen = chess.getFenList()[lastEat]
          let eatAfterMove = moveList.slice(lastEat + 1)
          // getAlphaBetaMove(lastEatFen, eatAfterMove)
          wait(lastEatFen, eatAfterMove)
        }
      })
      await go.run(inst)
      inst = await WebAssembly.instantiate(mod, go.importObject) // reset instance
    });

    async function move(step) {
      chess.movePieceByNode(step, 75)
    }

    async function wait(fen, list) {
      $.ajax({
        // url: "https://www.xiaxiangqi.com/api/cloud/bestmove",
        url: '/best',
        data: { fen: fen, move: list.join(",") },
        type: 'post',
        success: function (response) {
          console.log(response)
          move(response)
        }
      })
    }
  </script>

  <div class="vschess"></div>
</body>

</html>
